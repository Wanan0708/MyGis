# 瓦片地图下载修复说明

## 问题分析
通过分析代码，发现了以下主要问题：

1. **缓存目录设置错误**：原来设置为项目上级目录，现在改为项目下级目录
2. **网络请求超时时间过短**：从15秒增加到30秒
3. **并发请求数量过多**：从4个减少到2个，避免服务器压力过大
4. **缺少重试机制**：添加了3次重试机制
5. **中国区域配置不合理**：重新配置为中国区域（纬度18°N-54°N，经度73°E-135°E）

## 修复内容

### 1. 缓存目录修复
- **文件**: `tilemapmanager.cpp`
- **修改**: 将缓存目录从项目上级目录改为项目下级目录
- **代码**: `m_cacheDir = QDir::currentPath() + "/tilemap";`

### 2. 网络请求优化
- **文件**: `tileworker.cpp`
- **修改**: 
  - 超时时间从15秒增加到30秒
  - 更新User-Agent字符串
  - 添加缓存控制属性

### 3. 并发控制
- **文件**: `tilemapmanager.cpp`
- **修改**: 最大并发请求数从4减少到2
- **原因**: 避免对瓦片服务器造成过大压力

### 4. 重试机制
- **文件**: `tileworker.cpp`, `tileworker.h`
- **新增**: 
  - `performDownload()` 函数
  - 3次重试机制，递增等待时间
  - 智能错误处理（404错误不重试）

### 5. 中国区域配置
- **文件**: `myform.cpp`
- **修改**: 
  - 纬度范围：18°N - 54°N
  - 经度范围：73°E - 135°E
  - 缩放级别：3-8级

### 6. 服务器负载均衡
- **文件**: `tilemapmanager.cpp`
- **修改**: 使用多个OpenStreetMap服务器（a, b, c）分散负载

## 主要改进

1. **不会卡住主线程**：所有网络请求都在工作线程中执行
2. **智能重试**：网络错误会自动重试，404错误不重试
3. **合理的并发控制**：限制同时请求数量
4. **中国区域优化**：专门针对中国区域的地图下载
5. **本地缓存**：瓦片文件保存在项目目录下的tilemap文件夹中

## 使用方法

1. 编译项目
2. 运行应用程序
3. 点击"Load Tile Map"按钮开始下载
4. 下载的瓦片会保存在项目目录下的tilemap文件夹中

## 文件结构
```
项目目录/
├── tilemap/           # 瓦片缓存目录
│   ├── 3/             # 缩放级别3
│   ├── 4/             # 缩放级别4
│   └── ...
├── tilemap_debug.log  # 调试日志
└── debug.log          # 应用日志
```

## 注意事项

1. 首次下载可能需要较长时间，因为要下载多个缩放级别的瓦片
2. 网络连接不稳定时，重试机制会自动处理
3. 404错误表示该瓦片不存在，这是正常现象
4. 下载过程中可以在日志文件中查看详细进度
